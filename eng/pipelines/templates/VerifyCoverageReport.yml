parameters:
  - name: isDeltaBuild
    type: string

steps:
  - task: DownloadBuildArtifacts@0
    displayName: Download individual code coverage reports
    inputs:
      artifactName: CodeCoverageResults
      downloadPath: $(System.DefaultWorkingDirectory)

  - script: $(Build.SourcesDirectory)/.dotnet/dotnet dotnet-coverage merge
            $(System.DefaultWorkingDirectory)/CodeCoverageResults/*.cobertura.xml
            --output-format cobertura
            --output ./merged.cobertura.xml
    displayName: Merge code coverage reports

  # TEMP: PublishCodeCoverageResults@2 is currently broken. As a workaround run the task on Windows
  #       and use .NET 7, which the task depends on.
  #       See https://github.com/dotnet/extensions/issues/4124#issuecomment-1612369770.
  - task: UseDotNet@2
    displayName: 'Install .NET 7.x'
    inputs:
      version: '7.x'
      includePreviewVersions: true

  - task: PublishCodeCoverageResults@2
    displayName: Publish unified code coverage report
    inputs:
      summaryFileLocation: ./merged.cobertura.xml
      pathToSources: $(Build.SourcesDirectory)

  - pwsh: |
        $(Build.SourcesDirectory)/eng/scripts/ValidateProjectCoverage.ps1 -CoberturaReportXml ./merged.cobertura.xml
    displayName: Check per-project coverage
